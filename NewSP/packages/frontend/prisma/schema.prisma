// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  role          UserRole  @default(ARTIST)
  accounts      Account[]
  tracks        Track[]
  leads         Lead[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id          String       @id @default(cuid())
  type        AccountType
  provider    String
  accountId   String
  accessToken String?
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  tracks      Track[]
  lastSynced  DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([userId, provider, accountId])
}

model Track {
  id              String          @id @default(cuid())
  isrc            String?         @unique
  iswc            String?
  title           String
  artist          String
  label           String?
  releaseDate     DateTime?
  userId          String
  user            User            @relation(fields: [userId], references: [id])
  accountId       String?
  account         Account?        @relation(fields: [accountId], references: [id])
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations for arrays
  artists         TrackArtist[]
  producers       TrackProducer[]
  writers         TrackWriter[]
  platforms       PlatformLink[]
  registrations   Registration[]
  earnings        Earning[]
  missingFlags    MissingFlag[]
  verifications   Verification[]
  shareLinks      ShareLink[]
}

model TrackArtist {
  id        String   @id @default(cuid())
  trackId   String
  track     Track    @relation(fields: [trackId], references: [id])
  name      String
  order     Int?     @default(0)
  createdAt DateTime @default(now())

  @@unique([trackId, name])
  @@index([trackId])
}

model TrackProducer {
  id        String   @id @default(cuid())
  trackId   String
  track     Track    @relation(fields: [trackId], references: [id])
  name      String
  order     Int?     @default(0)
  createdAt DateTime @default(now())

  @@unique([trackId, name])
  @@index([trackId])
}

model TrackWriter {
  id        String   @id @default(cuid())
  trackId   String
  track     Track    @relation(fields: [trackId], references: [id])
  name      String
  order     Int?     @default(0)
  createdAt DateTime @default(now())

  @@unique([trackId, name])
  @@index([trackId])
}

model PlatformLink {
  id          String   @id @default(cuid())
  trackId     String
  track       Track    @relation(fields: [trackId], references: [id])
  platform    String
  url         String
  platformId  String
  createdAt   DateTime @default(now())
}

model Registration {
  id           String             @id @default(cuid())
  trackId      String
  track        Track              @relation(fields: [trackId], references: [id])
  pro          PRO
  type         RegistrationType
  status       RegistrationStatus
  registeredAt DateTime?
  territory    String?
  error        String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  @@unique([trackId, pro, type, territory])
}

model Earning {
  id         String        @id @default(cuid())
  trackId    String
  track      Track         @relation(fields: [trackId], references: [id])
  source     String
  amount     Float
  currency   String        @default("USD")
  period     String
  plays      Int?
  status     EarningStatus
  matchedAt  DateTime?
  createdAt  DateTime      @default(now())
}

model MissingFlag {
  id          String      @id @default(cuid())
  trackId     String
  track       Track       @relation(fields: [trackId], references: [id])
  type        FlagType
  severity    Severity
  description String
  amount      Float?
  status      FlagStatus  @default(OPEN)
  resolution  String?
  createdAt   DateTime    @default(now())
  resolvedAt  DateTime?
}

model Verification {
  id          String   @id @default(cuid())
  trackId     String
  track       Track    @relation(fields: [trackId], references: [id])
  proofHash   String   @unique
  verifiedAt  DateTime @default(now())
}

model ShareLink {
  id         String   @id @default(cuid())
  trackId    String
  track      Track    @relation(fields: [trackId], references: [id])
  slug       String   @unique
  expiresAt  DateTime?
  createdAt  DateTime @default(now())
}

model Lead {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  searchType   String?
  query        String?
  resultsFound Int?
  status       String   @default("new")
  userId       String?
  user         User?    @relation(fields: [userId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model UnclaimedRoyalty {
  id          String   @id @default(cuid())
  trackTitle  String
  artistName  String?
  writerName  String?
  isrc        String?
  source      String
  amount      Float
  confidence  String
  claimed     Boolean  @default(false)
  claimedBy   String?
  createdAt   DateTime @default(now())
  
  @@index([artistName])
  @@index([writerName])
  @@index([isrc])
}

enum UserRole {
  ARTIST
  LABEL
  PUBLISHER
  PRO
  ADMIN
}

enum AccountType {
  DISTRIBUTOR
  PRO
  LABEL
  PUBLISHER
  STREAMING
}

enum PRO {
  ASCAP
  BMI
  PRS
  SOCAN
  GEMA
  SACEM
  JASRAC
  APRA
  OTHER
}

enum RegistrationType {
  COMPOSITION
  SOUND_RECORDING
}

enum RegistrationStatus {
  REGISTERED
  PENDING
  MISSING
  ERROR
}

enum EarningStatus {
  MATCHED
  UNMATCHED
  FLAGGED
}

enum FlagType {
  MISSING_REGISTRATION
  METADATA_ERROR
  SPLIT_MISMATCH
  TERRITORY_GAP
  WRONG_ISRC
  MISSING_ISWC
  PRODUCER_CREDIT_MISSING
}

enum Severity {
  HIGH
  MEDIUM
  LOW
}

enum FlagStatus {
  OPEN
  RESOLVED
  IGNORED
}